# 안녕 삼각형

OpenGL에서는 모든 것이 3차원 공간에 있지만, 화면이나 창은 픽셀로 이루어진 2차원 배열입니다. 따라서 OpenGL의 주요 기능은 모든 3차원 좌표를 화면에 맞는 2차원 픽셀로 변환하는 것입니다. 3차원 좌표를 2차원 픽셀로 변환하는 과정은 OpenGL의 **그래픽 파이프라인(graphics pipeline)**{:.g}에서 처리됩니다. 그래픽 파이프라인은 크게 두 부분으로 나눌 수 있는데, 첫 번째 부분은 3차원 좌표를 화면에 그리기 위한 2차원 좌표로 변환하고, 두 번째 부분은 2차원 좌표를 실제 색상이 있는 픽셀로 변환합니다. 이 장에서는 그래픽 파이프라인에 대해 간략하게 살펴보고, 이를 활용하여 멋진 픽셀을 만드는 방법을 알아보겠습니다.

그래픽 파이프라인은 3D 좌표 세트를 입력으로 받아 화면상의 색상이 있는 2D 픽셀로 변환합니다. 그래픽 파이프라인은 여러 단계로 나눌 수 있으며, 각 단계는 이전 단계의 출력을 입력으로 필요로 합니다. 이러한 모든 단계는 고도로 전문화되어(각각 특정 기능만 수행) 병렬로 실행될 수 있습니다. 이러한 병렬 처리 특성 덕분에 오늘날의 그래픽 카드는 그래픽 파이프라인 내에서 데이터를 빠르게 처리하기 위해 수천 개의 소형 처리 코어를 갖추고 있습니다. 처리 코어는 파이프라인의 각 단계에 대해 GPU에서 작은 프로그램을 실행합니다. 이러한 작은 프로그램을 **셰이더**{:.g}라고 합니다.

일부 셰이더는 개발자가 구성할 수 있으므로 기존의 기본 셰이더를 대체할 자체 셰이더를 작성할 수 있습니다. 이를 통해 파이프라인의 특정 부분을 훨씬 더 세밀하게 제어할 수 있으며, GPU에서 실행되므로 귀중한 CPU 시간도 절약할 수 있습니다. 셰이더는 **OpenGL 셰이딩 언어**{:.g}(**OpenGL Shading Language**{:.g}, **GLSL**{:.g})로 작성되며, 다음 장에서 이에 대해 자세히 살펴보겠습니다.

아래는 그래픽 파이프라인의 모든 단계를 추상적으로 나타낸 것입니다. 파란색 부분은 우리가 직접 셰이더를 삽입할 수 있는 영역을 나타냅니다.

![](../static/pipeline.png)

보시다시피, 그래픽 파이프라인은 정점 데이터를 완전한 픽셀 렌더링으로 변환하는 과정의 각 부분을 처리하는 수많은 섹션으로 구성되어 있습니다. 파이프라인의 작동 방식을 쉽게 이해할 수 있도록 각 섹션을 간략하게 설명하겠습니다.

그래픽 파이프라인의 입력으로는 'Vertex Data'라는 배열에 삼각형을 형성해야 하는 세 개의 3D 좌표 목록을 전달합니다. 이 **정점(vertex)**{:.g} 데이터는 정점들의 모음입니다. 각 정점은 3D 좌표에 대한 데이터 모음입니다. 정점의 데이터는 **정점 속성(vertex attributes)**{:.g}을 사용하여 표현되며, 이 속성에는 원하는 모든 데이터를 담을 수 있지만, 간단하게 설명하기 위해 각 정점은 3D 위치와 색상 값으로만 ​​구성된다고 가정하겠습니다.

!!! tip ""
    OpenGL이 좌표와 색상 값의 모음을 어떻게 처리해야 할지 알기 위해서는, 어떤 종류의 렌더링 유형을 만들 것인지에 대한 힌트를 제공해야 합니다. 데이터를 점들의 모음으로 렌더링할지, 삼각형들의 모음으로 렌더링할지, 아니면 하나의 긴 선으로 렌더링할지 등을 지정해야 합니다. 이러한 힌트를 **프리미티브(primitives)**{:.g}라고 하며, 그리기 명령을 호출할 때 OpenGL에 전달됩니다. 이러한 힌트에는 GL_POINTS, GL_TRIANGLES, GL_LINE_STRIP 등이 있습니다.

파이프라인의 첫 번째 부분은 단일 정점을 입력으로 받는 **정점 셰이더**{:.g}입니다. 정점 셰이더의 주요 목적은 3D 좌표를 다른 3D 좌표로 변환하는 것이며(자세한 내용은 나중에 설명), 정점 속성에 대한 기본적인 처리를 수행할 수 있도록 해줍니다.

정점 셰이더 단계의 출력은 선택적으로 **지오메트리 셰이더**{:.g}로 전달됩니다. 지오메트리 셰이더는 기본 도형을 구성하는 정점들의 모음을 입력으로 받으며, 새로운 정점을 생성하여 새로운 (또는 다른) 기본 도형을 만들어 다른 형태를 생성할 수 있습니다. 이 예제에서는 주어진 도형에서 두 번째 삼각형을 생성합니다.

**기본 도형 조립(primitive assembly)**{:.g} 단계는 정점 셰이더(또는 `GL_POINTS`가 선택된 경우 정점)에서 하나 이상의 기본 도형을 구성하는 모든 정점을 입력으로 받아 주어진 기본 도형 모양(이 경우 두 개의 삼각형)의 모든 점을 조립합니다.

기본 도형 조립 단계의 출력은 **래스터화 단계(rasterization stage)**{:.g}로 전달되어 최종 화면의 해당 픽셀에 매핑됩니다. 이렇게 생성된 프래그먼트는 프래그먼트 셰이더에서 사용됩니다. 프래그먼트 셰이더가 실행되기 전에 **클리핑**{:.g}이 수행됩니다. 클리핑은 사용자의 시야 범위를 벗어난 모든 프래그먼트를 제거하여 성능을 향상시킵니다.

!!! tip ""
    OpenGL에서 프래그먼트는 OpenGL이 단일 픽셀을 렌더링하는 데 필요한 모든 데이터입니다.

**프래그먼트 셰이더(fragment shader)**{:.g}의 주요 목적은 픽셀의 최종 색상을 계산하는 것이며, 일반적으로 모든 고급 OpenGL 효과가 구현되는 단계입니다. 프래그먼트 셰이더는 보통 3D 장면에 대한 데이터(예: 조명, 그림자, 조명의 색상 등)를 포함하고 있으며, 이를 사용하여 최종 픽셀 색상을 계산합니다.

모든 해당 색상 값이 결정되면 최종 객체는 **알파 테스트**{:.g} 및 **블렌딩 단계**{:.g}라고 하는 마지막 단계를 거칩니다. 이 단계에서는 프래그먼트의 해당 깊이(및 스텐실) 값(나중에 자세히 설명)을 확인하고, 결과 프래그먼트가 다른 객체 앞에 있는지 뒤에 있는지 판단하여 그에 따라 폐기해야 하는지 결정합니다. 또한 **알파**{:.g} 값(알파 값은 객체의 불투명도를 정의함)을 확인하고 그에 따라 객체를 **블렌딩**{:.g}합니다. 따라서 프래그먼트 셰이더에서 픽셀 출력 색상이 계산되더라도 여러 삼각형을 렌더링할 때 최종 픽셀 색상은 완전히 다를 수 있습니다.

보시다시피 그래픽 파이프라인은 상당히 복잡하며 여러 가지 설정 가능한 부분을 포함하고 있습니다. 하지만 거의 모든 경우에 우리는 정점 셰이더와 프래그먼트 셰이더만 사용하면 됩니다. 지오메트리 셰이더는 선택 사항이며 일반적으로 기본 셰이더를 사용합니다. 또한 여기서는 묘사하지 않았지만 테셀레이션 단계와 변환 피드백 루프가 있으며, 이는 나중에 자세히 다루겠습니다.

최신 OpenGL에서는 정점 셰이더와 프래그먼트 셰이더를 직접 정의해야 합니다(GPU에 기본 정점/프래그먼트 셰이더가 제공되지 않습니다). 따라서 최신 OpenGL을 배우기 시작하는 것은 상당히 어려울 수 있습니다. 첫 번째 삼각형을 렌더링하기 전에 많은 지식이 필요하기 때문입니다. 하지만 이 장을 마치고 마침내 삼각형을 렌더링하게 되면 그래픽 프로그래밍에 대해 훨씬 더 많이 알게 될 것입니다.

## 정점 입력

무언가를 그리기 시작하려면 먼저 OpenGL에 정점 데이터를 입력해야 합니다. OpenGL은 3D 그래픽 라이브러리이므로 OpenGL에서 지정하는 모든 좌표는 3D 공간(x, y, z 좌표)에 있습니다. OpenGL은 모든 3D 좌표를 화면의 2D 픽셀로 단순히 변환하지 않습니다. OpenGL은 3축(x, y, z) 모두에서 좌표가 -1.0에서 1.0 사이의 특정 범위에 있을 때만 3D 좌표를 처리합니다. 이른바 **정규화된 장치 좌표(normalized device coordinates)**{:.g} 범위 내에 있는 모든 좌표는 화면에 표시되고, 이 범위를 벗어난 좌표는 표시되지 않습니다.

하나의 삼각형을 렌더링하기 위해 총 세 개의 정점을 지정해야 하며, 각 정점은 3D 위치를 갖습니다. 이 정점들은 OpenGL의 가시 영역인 정규화된 장치 좌표계로 아래와 같은 float 배열에 정의됩니다.

```c++
float vertices[] = {
    -0.5f, -0.5f, 0.0f,
     0.5f, -0.5f, 0.0f,
     0.0f,  0.5f, 0.0f
};  
```

OpenGL은 3D 공간에서 작동하기 때문에 각 꼭짓점의 z축 좌표가 0.0인 2D 삼각형을 렌더링합니다. 이렇게 하면 삼각형의 깊이가 그대로 유지되어 2D처럼 보이게 됩니다.

!!! tip ""
    **Normalized Device Coordinates (NDC)**
    정점 셰이더에서 정점 좌표가 처리되면, x, y, z 값이 -1.0에서 1.0 사이의 작은 범위인 **정규화된 장치 좌표(normalized device coordinates)**{:.g}로 변환됩니다. 이 범위를 벗어나는 좌표는 버려지거나 잘려나가 화면에 표시되지 않습니다. 아래 그림에서 정규화된 장치 좌표(z축 제외)로 표현된 삼각형을 확인할 수 있습니다.

    ![](../static/ndc.png)

    일반적인 화면 좌표계와 달리 양의 y축은 위쪽 방향을 가리키고 (0,0) 좌표는 그래프의 왼쪽 상단이 아닌 중앙에 위치합니다. 최종적으로 모든 (변환된) 좌표가 이 좌표 공간 안에 있어야 하며, 그렇지 않으면 표시되지 않습니다.

    그러면 NDC 좌표는 glViewport 함수로 제공한 데이터를 사용하여 뷰포트 변환을 통해 화면 공간 좌표로 변환됩니다. 이렇게 변환된 화면 공간 좌표는 다시 프래그먼트 셰이더의 입력으로 사용될 프래그먼트 좌표로 변환됩니다.


